We want to implement QR code scanning via an iOS device’s camera, initiated from a responsive web page generated by a Rails 8 application using Stimulus, Propshaft, and Importmap.

1. Set Up the Rails Environment
  • Initialize a New Rails Application: Create a new Rails 8 application with Propshaft and Importmap configured.

rails new qr_scanner_app --css=tailwind --javascript=importmap


  • Install Stimulus: Ensure Stimulus is installed to manage JavaScript behavior.

bin/rails stimulus:install



2. Pin the QR Code Scanning Library
  • Choose a QR Code Library: Utilize a JavaScript library like html5-qrcode for QR code scanning.
  • Pin the Library Using Importmap: Add the library to your Importmap configuration.

bin/importmap pin html5-qrcode



3. Create the Stimulus Controller
  • Generate a Stimulus Controller: Create a controller to handle QR code scanning logic.

bin/rails generate stimulus qr_scanner


  • Implement Scanning Logic: In app/javascript/controllers/qr_scanner_controller.js, set up the QR code scanner.

import { Controller } from "@hotwired/stimulus"
import { Html5Qrcode } from "html5-qrcode"

export default class extends Controller {
  static targets = ["video"]

  connect() {
    this.html5QrCode = new Html5Qrcode(this.videoTarget.id)
  }

  startScan() {
    this.html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      },
      qrCodeMessage => {
        console.log(`QR Code detected: ${qrCodeMessage}`)
        // Handle the scanned QR code message
      },
      errorMessage => {
        console.debug(`QR Code scan error: ${errorMessage}`)
      }
    ).catch(err => {
      console.error(`Unable to start scanning: ${err}`)
    })
  }

  stopScan() {
    this.html5QrCode.stop().then(() => {
      console.log("QR Code scanning stopped.")
    }).catch(err => {
      console.error(`Unable to stop scanning: ${err}`)
    })
  }
}

This controller initializes the QR code scanner on the specified video element and defines methods to start and stop scanning.

4. Integrate into the View
  • Set Up the HTML Structure: In the relevant view file (e.g., app/views/home/index.html.erb), add the following:

<div data-controller="qr-scanner">
  <div id="qr-video" data-qr-scanner-target="video"></div>
  <button type="button" onclick="qrScanner.startScan()">Start Scan</button>
  <button type="button" onclick="qrScanner.stopScan()">Stop Scan</button>
</div>

This structure sets up the video display area and buttons to control scanning.
